##
# SWAY WINDOW MANAGER
##

#
# VARIABLES
#

#
# Appearance
#

set $font Input Sans Condensed 9
set $colors catppuccin

set $termpopupwidth 920
set $termpopupheight 920

set $termscratchwidth 1790
set $termscratchheight 940

set $fuzzytermwidth 600
set $fuzzytermheight 350

#
# Keys
#

set $mod Mod4
set $left h
set $down j
set $up k
set $right l

#
# Workspaces
#

set $workspace1 1
set $workspace2 2
set $workspace3 3
set $workspace4 4
set $workspace5 5
set $workspace6 6
set $workspace7 7
set $workspace8 8
set $workspace9 9
set $workspace10 10

#
# Commands
#

# Terminals
#   TODO: Make titles consistent with variables and adjust Waybar config accordingly.

set $term kitty --single-instance
set $termpopup $term --title popupterm
set $termscratch $term --title scratchterm --session /etc/nixos/config/kitty/scratchpad.session

# Launchers

set $launchapp /etc/nixos/scripts/launch/launch-application
set $launchcmd /etc/nixos/scripts/launch/launch-command
set $launchgui wofi

# Files

set $filesqt5 dolphin
set $filesgtk nautilus
set $filestui $termpopup -e vifm

# Screenshots

set $snaparea grim -g "$(slurp)" - | swappy -f - -o "$HOME/Pictures/Screenshots/$(date +%Y%m%d_%Hh%Mm%Ss)_area.png"
set $snapfull grim -g "$(slurp -o)" - | swappy -f - -o "$HOME/Pictures/Screenshots/$(date +%Y%m%d_%Hh%Mm%Ss)_screen.png"

# Window properties
set $swaypropsattrs \
  name, \
  type, \
  title, \
  app_id, \
  con_mark, \
  con_type, \
  marks, \
  sticky, \
  pid, \
  nodes, \
  fullscreen_mode, \
  urgent, \
  orientation, \
  layout, \
  focused, \
  border, \
  rect
set $swayprops sh -c "swaymsg -t get_tree | jq '.. | select(.type?) | select(.focused==true) | { $swaypropsattrs }' > /tmp/sway-props.json && $termpopup -e -- bat --paging=always --style=plain --theme=Dracula /tmp/sway-props.json"
set $swaypropsall sh -c "swaymsg -t get_tree | jq '.. | select(.type?) | select(.focused==true)' > /tmp/sway-props.json && $termpopup -e -- bat --paging=always --style=plain --theme=Dracula /tmp/sway-props.json"

# Lockscreen

set $lock swaylock \
  --font "Input Sans Compressed" \
  --font-size 12 \
  --scaling fill \
  --ignore-empty-password \
  --indicator-radius 150 \
  --indicator-thickness 10 \
  --inside-color "#2e3440" \
  --inside-ver-color "#2e3440" \
  --key-hl-color "#88c0d0" \
  --ring-color "#2e3440" \
  --ring-ver-color "#2e3440" \
  --separator-color "#2e3440" \
  --line-uses-inside \
  --layout-bg-color "#00000000" \
  --layout-border-color "#00000000" \
  --layout-text-color "#eceff4" \
  --clock \
  --screenshots \
  --indicator-idle-visible \
  --datestr "%H:%M" \
  --timestr "%A" \
  --grace 1 \
  --fade-in 1 \
  --effect-greyscale \
  --effect-blur 6x8 \
  --effect-vignette 0.6:0.8

# Power menu

set $powermenu wlogout \
  --buttons-per-row 2 \
  --row-spacing 34 \
  --column-spacing 34 \
  --margin 34 \
  --protocol layer-shell

#
# SETTINGS
#

#
# Appearance
#

font pango:$font

# Gaps

gaps inner 12
gaps outer 10

smart_gaps off

# Borders (pixel border type disables title bar)

default_border pixel 4
default_floating_border pixel 4

hide_edge_borders smart_no_gaps

#
# Workspaces
#

# Show next if attempting to focus outside current
focus_wrapping workspace

# Show previous if repeating Mod+Number
workspace_auto_back_and_forth yes

# Assign to outputs
workspace $workspace1 output DP-1
workspace $workspace2 output DP-1
workspace $workspace3 output DP-1
workspace $workspace4 output DP-1
workspace $workspace5 output DP-1
workspace $workspace6 output DVI-D-1
workspace $workspace7 output DVI-D-1
workspace $workspace8 output DVI-D-1
workspace $workspace9 output DVI-D-1
workspace $workspace10 output DVI-D-1

#
# OUTPUTS
#

# All monitors
output "*" bg ~/Pictures/Wallpapers/active3.jpg fill

# Primary monitor
output "DP-1" {
  mode 1920x1080@144.001007Hz
  position 1920,0
}

# Secondary monitor
output "DVI-D-1" {
  mode 1920x1080@60Hz
  position 0,0
}

#
# INPUTS
# 
# Notes:
#   - Using ID instead of "*" can prevent Firefox from crashing on configuration reload
#

seat seat0 hide_cursor when-typing enable
seat seat0 xcursor_theme "Quintom_Snow" 24

input "12851:25345:Ducky_Ducky_One2_Mini_RGB" {
  repeat_delay 250
  repeat_rate 35

  xkb_layout us,se

  # CapsLock -> Escape
  # LShift+RShift -> CapsLock
  # LCtrl+RCtrl -> Switch layout
  # RAlt -> AltGr
  # Shift+RAlt -> Compose
  xkb_options caps:escape,shift:both_capslock,grp:ctrls_toggle,lv3:ralt_switch_multikey
}

input "1452:613:Apple_Inc._Magic_Trackpad_2" {
  tap enable
  click_method clickfinger
}

#
# KEY MAPS
#

# Drag windows by holding down $mod and left mouse button.
# Resize with right mouse button + $mod.
# Change normal to inverse to use left button for resizing.
floating_modifier $mod normal

# To map single press on mod key to launch menu:
# set $modrelease (pgrep $menu 1>/dev/null 2>&1 && pkill $menu) || $menu $menuargs | xargs swaymsg exec

bindsym {
  #
  # Launchers
  #   Mod+Return            -> FZF applications
  #   Mod+Shift+Return      -> FZF commands
  #   Mod+Shift+Ctrl+Return -> GUI launcher
  #   Mod+Shift+.           -> GUI emoji picker
  #

  $mod+d exec $launchapp
  $mod+Shift+d exec $launchcmd
  $mod+Shift+Ctrl+d $launchgui
  $mod+Shift+period exec wofi-emoji

  #
  # Terminal emulators
  #   Mod+Return            -> Plain
  #   Mod+Shift+Return      -> Scratchpad
  #   Mod+Shift+Ctrl+Return -> Plain in scratchpad
  #
  $mod+Return exec $term
  $mod+Shift+Return exec $termscratch
  $mod+Shift+Ctrl+Return exec $term, move scratchpad
  
  #
  # File managers
  #

  $mod+g exec $filesqt5
  $mod+Shift+g exec $filesgtk
  $mod+Shift+Ctrl+g exec $filestui

  #
  # WM
  #

  $mod+q kill
  $mod+Backspace exec $powermenu
  $mod+Shift+p exec $swayprops
  $mod+Shift+Ctrl+p exec $swaypropsall
  $mod+Shift+c reload

  #
  # Movement
  #

  # Focus windows

  $mod+$left focus left
  $mod+$down focus down
  $mod+$up focus up
  $mod+$right focus right

  # Move windows

  $mod+Shift+$left move left
  $mod+Shift+$down move down
  $mod+Shift+$up move up
  $mod+Shift+$right move right

  # Focus workspace: Number keys

  $mod+1 workspace number 1
  $mod+2 workspace number 2
  $mod+3 workspace number 3
  $mod+4 workspace number 4
  $mod+5 workspace number 5
  $mod+6 workspace number 6
  $mod+7 workspace number 7
  $mod+8 workspace number 8
  $mod+9 workspace number 9
  $mod+0 workspace number 10

  # Focus workspace: Mod+Tab switches, Alt+Tab cycles

  $mod+Tab workspace back_and_forth

  Alt+Tab workspace next_on_output
  Alt+Shift+Tab workspace prev_on_output

  # Focus workspace: HJKL
  
  $mod+Alt+$left workspace prev_on_output
  $mod+Alt+$down workspace next_on_output
  $mod+Alt+$up workspace prev_on_output
  $mod+Alt+$right workspace next_on_output

  # Move window to workspace and focus

  $mod+Shift+1 move container to workspace number 1, workspace number 1
  $mod+Shift+2 move container to workspace number 2, workspace number 2
  $mod+Shift+3 move container to workspace number 3, workspace number 3
  $mod+Shift+4 move container to workspace number 4, workspace number 4
  $mod+Shift+5 move container to workspace number 5, workspace number 5
  $mod+Shift+6 move container to workspace number 6, workspace number 6
  $mod+Shift+7 move container to workspace number 7, workspace number 7
  $mod+Shift+8 move container to workspace number 8, workspace number 8
  $mod+Shift+9 move container to workspace number 9, workspace number 9
  $mod+Shift+0 move container to workspace number 10, workspace number 10

  #
  # Layout 
  #
  
  # Split direction

  $mod+b splith
  $mod+v splitv

  # Modes
  
  $mod+Space focus mode_toggle
  $mod+Shift+Space floating toggle

  $mod+s layout stacking
  $mod+w layout tabbed
  $mod+e layout toggle split

  $mod+a focus parent
  $mod+f fullscreen

  #
  # Scratchpad
  #
  
  $mod+z scratchpad show, [con_mark="fullterm"] fullscreen enable
  $mod+Shift+z move scratchpad, mark --add newest
  $mod+Shift+Ctrl+z fullscreen enable, mark --add fullterm
  $mod+Shift+Ctrl+x fullscreen disable, mark --remove fullterm

  #
  # Functional
  #

  # Audio
  
  XF86AudioRaiseVolume exec pactl set-sink-volume @DEFAULT_SINK@ +5%
  XF86AudioLowerVolume exec pactl set-sink-volume @DEFAULT_SINK@ -5%
  XF86AudioMute exec pactl set-sink-mute @DEFAULT_SINK@ toggle
}

#
# MODES (e.g. resize or navigate)
#

#
# Vim mode
#
#   h -> left
#   j -> down
#   k -> up
#   l -> right
#   0 -> home
#   $ -> end
#

set $mode_vim_icon 
set $mode_vim_title Vim
set $mode_vim_hints (h) left (j) down (k) up (l) right…
set $mode_vim $mode_vim_icon $mode_vim_title $mode_vim_hints

mode "$mode_vim" {
  bindsym {
    h exec wtype -k left
    j exec wtype -k down
    k exec wtype -k up
    l exec wtype -k right
    0 exec wtype -k home
    dollar exec wtype -k end
    Ctrl+u exec wtype -k pageup
    Ctrl+d exec wtype -k pagedown
  }

  bindsym Return mode "default"
  bindsym Escape mode "default"
  bindsym Space mode "default"
}

bindsym $mod+n mode "$mode_vim"

#
# Screenshot mode
#
#   a -> select area
#   s -> select screen
#   PrintSc -> select area (PrintSc > PrintSc)
#

set $mode_snap_icon 
set $mode_snap_title Screenshot
set $mode_snap_hints (a)rea (s)creen
set $mode_snap $mode_snap_icon $mode_snap_title $mode_snap_hints

mode "$mode_snap" {
  bindsym Print mode default, exec $snaparea
  bindsym a mode default, exec $snaparea
  bindsym s mode default, exec $snapfull

  bindsym Return mode "default"
  bindsym Escape mode "default"
  bindsym Space mode "default"
}

bindsym Print mode "$mode_snap"

#
# Resize mode
#
#   h -> thinner
#   j -> taller
#   k -> shorter
#   l -> wider
#


set $mode_resize_icon 
set $mode_resize_title Resize
set $mode_resize_hints (h) thinner (j) taller (k) shorter (l) wider
set $mode_resize $mode_resize_icon $mode_resize_title $mode_resize_hints

mode "$mode_resize" {
  bindsym $left resize shrink width 20px
  bindsym $down resize grow height 20px
  bindsym $up resize shrink height 20px
  bindsym $right resize grow width 20px

  bindsym Left resize shrink width 20px
  bindsym Down resize grow height 20px
  bindsym Up resize shrink height 20px
  bindsym Right resize grow width 20px

  bindsym Return mode "default"
  bindsym Escape mode "default"
  bindsym Space mode "default"
}

bindsym $mod+r mode "$mode_resize"

#
# System mode
#

set $mode_system_icon 襤
set $mode_system_label System
set $mode_system_hints (l)ogout (r)estart (s)shutdown (c)onfi
set $mode_system $mode_system_icon $mode_system_label $mode_system_hints

mode "$mode_system" {
  bindsym e exec swaymsg exit, mode "default"
  bindsym s exec systemctl poweroff, mode "default"
  bindsym r exec systemctl reboot, mode "default"
  bindsym c exec swaymsg reload, mode "default"

  bindsym Return mode "default"
  bindsym Escape mode "default"
  bindsym Space mode "default"
}

bindsym $mod+Shift+e mode "$mode_system"

#
# WINDOW SPECIFIC
#

for_window {
  #
  # File managers
  #

  [app_id="org.gnome.Nautilus"] floating enable
  [app_id="org.kde.dolphin"] floating enable, resize set 1550 900

  #
  # Dialogs
  #

  # General
  [window_role="pop-up"] floating enable
  [window_role="bubble"] floating enable
  [window_role="dialog"] floating enable
  [window_type="dialog"] floating enable

  # Sound
  [app_id="pavucontrol"] floating enable

  # Password
  [app_id="pinentry-qt"] floating enable
  [app_id="pinentry-gtk2"] floating enable

  #
  # Launchers
  #

  [app_id="wofi"] floating enable, sticky enable, border none

  #
  # Tray
  #

  [title="nm-tray"] floating enable, sticky enable
  [title="nmtui-edit"] floating enable
  [title="Connection information"] floating enable
  [instance="bitwarden"] floating enable
  
  #
  # Terminals
  #

  # Scratchpad

  [title="scratchterm"] \
    move scratchpad, \
    resize set $termscratchwidth $termscratchheight, \
    move position center
  [title="scratchterm" con_mark="fullterm"] \
    fullscreen enable

  # Popup

  [title="popupterm"] \
    floating enable, \
    resize set $termpopupwidth $termpopupheight

  # Launcher

  [title="fuzzyterm"] \
    floating enable, \
    sticky enable, \
    resize set $fuzzytermwidth $fuzzytermheight

  # Transparent

  [title="transterm"] border none

  #
  # Utilities
  #

  # qt5ct

  [app_id="qt5ct"] floating enable, resize set 1100 900

  # Kvantum Manager

  [title="Kvantum Manager"] floating enable, resize set 1200 860
}

#
# STARTUP
#

# Import environment

exec systemctl --user import-environment XDG_SESSION_TYPE XDG_CURRENT_DESKTOP
exec dbus-update-activation-environment WAYLAND_DISPLAY
exec ~/.nix-profile/libexec/polkit-gnome-authentication-agent-1

# Start systemd targets

exec systemctl --user start sway-session.target
exec systemctl --user start graphical-session.target

# Start scratchpad terminal

exec $termscratch

# Turn off monitor after 10 minutes and lock screen after 30 minutes

exec swayidle -w \
  timeout 900 'swaymsg "output * dpms off"' resume 'swaymsg "output * dpms on"' \
  timeout 1800 '$lock' \
  before-sleep '$lock'

# Don't turn off monitor if any app is fullscreen

for_window {
  [class="^.*"] inhibit_idle fullscreen
  [app_id="^.*"] inhibit_idle fullscreen
}

# Start flashfocus for flashing window animation on focus change
exec_always pkill flashfocus ; flashfocus > /tmp/flashfocus.log 2>&1

# Start swayr daemon
exec_always pkill swayrd ; env RUST_BACKTRACE=1 swayrd > /tmp/swayrd.log 2>&1

# Start inactive window dimmer
exec_always pkill -f sway-dim-inactive-windows ; sway-dim-inactive-windows --opacity 0.9 > /tmp/sway-dim-inactive-windows.log 2>&1

# Start monitor temperature daemon
exec_always pkill wlsunset ; wlsunset -t 4500 -T 6500 -l 62.39 -L 17.30 > /tmp/wlsunset.log 2>&1

# Start network manager tray application
exec_always pkill nm-tray ; nm-tray

#
# STATUS BAR
#

bar {
  swaybar_command waybar
}

#
# GTK SETTINGS
#

set $gnome-schema org.gnome.desktop.interface

exec_always {
  gsettings set $gnome-schema gtk-theme "Ayu-Dark"
  gsettings set $gnome-schema icon-theme "Vimix-dark"
  gsettings set $gnome-schema cursor-theme "Quintom_Snow"
  gsettings set $gnome-schema font-name "Input Sans Compressed 8"
}

#
# INCLUDES
#

include colors.$colors
